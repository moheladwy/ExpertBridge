services:
  ExpertBridgeRedis:
    container_name: ExpertBridgeRedis
    image: "redis:alpine"
    volumes:
    - "expertbridge-redis-data:/data"
    command:
    - "--save"
    - "300"
    - "1"
    networks: 
      - expert-bridge-network
    healthcheck:
      test: "redis-cli ping"
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
  
  ExpertBridgeApi:
    image: "only1adwy/expert-bridge-api:latest"
    container_name: ExpertBridgeApi
    ports:
      - target: 8080
        published: 8080
    env_file:
      - ".env"
    environment:
      OTEL_DOTNET_EXPERIMENTAL_OTLP_EMIT_EXCEPTION_LOG_ATTRIBUTES: ${OTEL_DOTNET_EXPERIMENTAL_OTLP_EMIT_EXCEPTION_LOG_ATTRIBUTES}
      OTEL_DOTNET_EXPERIMENTAL_OTLP_EMIT_EVENT_LOG_ATTRIBUTES: ${OTEL_DOTNET_EXPERIMENTAL_OTLP_EMIT_EVENT_LOG_ATTRIBUTES}
      OTEL_DOTNET_EXPERIMENTAL_OTLP_RETRY: ${OTEL_DOTNET_EXPERIMENTAL_OTLP_RETRY}
      ASPNETCORE_FORWARDEDHEADERS_ENABLED: ${ASPNETCORE_FORWARDEDHEADERS_ENABLED}
      ASPNETCORE_ENVIRONMENT: ${ASPNETCORE_ENVIRONMENT}
      HTTP_PORTS: ${HTTP_PORTS}
      ConnectionStrings__Redis: ${ConnectionStrings__Redis}
      ConnectionStrings__Postgresql: ${ConnectionStrings__Postgresql}
      ConnectionStrings__Seq: ${ConnectionStrings__Seq}
      Firebase__Type: ${Firebase__Type}
      Firebase__ProjectId: ${Firebase__ProjectId}
      Firebase__PrivateKeyId: ${Firebase__PrivateKeyId}
      Firebase__PrivateKey: ${Firebase__PrivateKey}
      Firebase__ClientEmail: ${Firebase__ClientEmail}
      Firebase__ClientId: ${Firebase__ClientId}
      Firebase__AuthUri: ${Firebase__AuthUri}
      Firebase__TokenUri: ${Firebase__TokenUri}
      Firebase__auth_provider_x509_cert_url: ${Firebase__auth_provider_x509_cert_url}
      Firebase__client_x509_cert_url: ${Firebase__client_x509_cert_url}
      Firebase__UniverseDomain: ${Firebase__UniverseDomain}
      Authentication__Firebase__Issuer: ${Authentication__Firebase__Issuer}
      Authentication__Firebase__Audience: ${Authentication__Firebase__Audience}
      Authentication__Firebase__TokenUri: ${Authentication__Firebase__TokenUri}
      AwsS3__Region: ${AwsS3__Region}
      AwsS3__BucketName: ${AwsS3__BucketName}
      AwsS3__AwsKey: ${AwsS3__AwsKey}
      AwsS3__AwsSecret: ${AwsS3__AwsSecret}
      AwsS3__BucketUrl: ${AwsS3__BucketUrl}
    volumes:
      - ./FirebaseOAuthCredentialsExpertBridge.json:/ExpertBridge/FirebaseOAuthCredentialsExpertBridge.json
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
    networks: 
      - expert-bridge-network
      - postgres_network
      - prometheus
    depends_on:
      - ExpertBridgeRedis
    restart: unless-stopped
  
  Seq:
      container_name: "seq"
      image: "docker.io/datalust/seq:2024.3"
      environment:
        ACCEPT_EULA: "Y"
      volumes:
      - "expertbridge-seq-data:/data"
      networks:
          - expert-bridge-network 
      ports:
      - target: 80
        published: 4002
      - target: 5341
        published: 5341
      restart: unless-stopped
      
volumes:
  expertbridge-redis-data: 
    name: "expertbridge-redis-data"
    driver: local
  expertbridge-seq-data:
    name: "expertbridge-seq-data"
    driver: local

networks:
  expert-bridge-network:
    driver: bridge
    name: "expert-bridge-network"
  postgres_network:
    driver: bridge
    name: postgres_network
    external: true
  prometheus:
    name: prometheus
    external: true