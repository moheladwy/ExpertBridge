@page "/Account/Manage/Email"

@using System.ComponentModel.DataAnnotations
@using System.Text
@using System.Text.Encodings.Web
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.WebUtilities

@inject UserManager<Database.Admin> UserManager
@inject IEmailSender<Database.Admin> EmailSender
@inject IdentityUserAccessor UserAccessor
@inject NavigationManager NavigationManager

<PageTitle>Manage email</PageTitle>

<RadzenStack Gap="1.5rem">
    <RadzenText TextStyle="TextStyle.H4" TagName="TagName.H3">Manage email</RadzenText>
    
    <StatusMessage Message="@message"/>
    
    <RadzenRow>
        <RadzenColumn Size="12" SizeXL="6">
            <form @onsubmit="OnSendEmailVerificationAsync" @formname="send-verification" id="send-verification-form" method="post">
                <AntiforgeryToken/>
            </form>
            
            <EditForm Model="Input" FormName="change-email" OnValidSubmit="OnValidSubmitAsync" method="post">
                <DataAnnotationsValidator/>
                <RadzenStack Gap="1rem">
                    <ValidationSummary class="text-danger" role="alert"/>
                    
                    @if (isEmailConfirmed)
                    {
                        <RadzenFormField Text="Email" Variant="Variant.Outlined">
                            <ChildContent>
                                <RadzenStack Orientation="Orientation.Horizontal" Gap="0" Style="width: 100%;">
                                    <RadzenTextBox Value="@email" Disabled="true" Style="flex: 1; border-top-right-radius: 0; border-bottom-right-radius: 0;"/>
                                    <div style="display: flex; align-items: center; padding: 0 1rem; background-color: var(--rz-success); color: white; border-top-right-radius: 4px; border-bottom-right-radius: 4px;">
                                        <strong>✓</strong>
                                    </div>
                                </RadzenStack>
                            </ChildContent>
                        </RadzenFormField>
                    }
                    else
                    {
                        <RadzenFormField Text="Email" Variant="Variant.Outlined">
                            <ChildContent>
                                <RadzenTextBox Value="@email" Disabled="true" Style="width: 100%;"/>
                            </ChildContent>
                            <Helper>
                                <RadzenButton ButtonType="ButtonType.Submit" ButtonStyle="ButtonStyle.Light" Text="Send verification email" Size="ButtonSize.Small" form="send-verification-form"/>
                            </Helper>
                        </RadzenFormField>
                    }
                    
                    <RadzenFormField Text="New email" Variant="Variant.Outlined">
                        <ChildContent>
                            <RadzenTextBox @bind-Value="Input.NewEmail" Name="Input.NewEmail" Style="width: 100%;" autocomplete="email" Placeholder="Enter a new email"/>
                        </ChildContent>
                        <Helper>
                            <ValidationMessage For="() => Input.NewEmail"/>
                        </Helper>
                    </RadzenFormField>
                    
                    <RadzenButton ButtonType="ButtonType.Submit" ButtonStyle="ButtonStyle.Primary" Text="Change email" Style="width: 100%;"/>
                </RadzenStack>
            </EditForm>
        </RadzenColumn>
    </RadzenRow>
</RadzenStack>

@code {
    private string? message;
    private Database.Admin user = default!;
    private string? email;
    private bool isEmailConfirmed;

    [CascadingParameter] private HttpContext HttpContext { get; set; } = default!;

    [SupplyParameterFromForm(FormName = "change-email")]
    private InputModel Input { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        user = await UserAccessor.GetRequiredUserAsync(HttpContext);
        email = await UserManager.GetEmailAsync(user);
        isEmailConfirmed = await UserManager.IsEmailConfirmedAsync(user);

        Input.NewEmail ??= email;
    }

    private async Task OnValidSubmitAsync()
    {
        if (Input.NewEmail is null || Input.NewEmail == email)
        {
            message = "Your email is unchanged.";
            return;
        }

        var userId = await UserManager.GetUserIdAsync(user);
        var code = await UserManager.GenerateChangeEmailTokenAsync(user, Input.NewEmail);
        code = WebEncoders.Base64UrlEncode(Encoding.UTF8.GetBytes(code));
        var callbackUrl = NavigationManager.GetUriWithQueryParameters(
            NavigationManager.ToAbsoluteUri("Account/ConfirmEmailChange").AbsoluteUri,
            new Dictionary<string, object?> { ["userId"] = userId, ["email"] = Input.NewEmail, ["code"] = code });

        await EmailSender.SendConfirmationLinkAsync(user, Input.NewEmail, HtmlEncoder.Default.Encode(callbackUrl));

        message = "Confirmation link to change email sent. Please check your email.";
    }

    private async Task OnSendEmailVerificationAsync()
    {
        if (email is null)
        {
            return;
        }

        var userId = await UserManager.GetUserIdAsync(user);
        var code = await UserManager.GenerateEmailConfirmationTokenAsync(user);
        code = WebEncoders.Base64UrlEncode(Encoding.UTF8.GetBytes(code));
        var callbackUrl = NavigationManager.GetUriWithQueryParameters(
            NavigationManager.ToAbsoluteUri("Account/ConfirmEmail").AbsoluteUri,
            new Dictionary<string, object?> { ["userId"] = userId, ["code"] = code });

        await EmailSender.SendConfirmationLinkAsync(user, email, HtmlEncoder.Default.Encode(callbackUrl));

        message = "Verification email sent. Please check your email.";
    }

    private sealed class InputModel
    {
        [Required]
        [EmailAddress]
        [Display(Name = "New email")]
        public string? NewEmail { get; set; }
    }

}
